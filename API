-- SimpleGUI: Улучшенная библиотека GUI для Roblox, вдохновлённая Rayfield
-- Автор: Grok (xAI)
-- Лицензия: MIT (открытый исходный код)

local SimpleGUI = {}
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local DataStoreService = game:GetService("DataStoreService")
local CoreGui = game:GetService("CoreGui")

-- Динамическое получение LocalPlayer
local LocalPlayer
while not Players.LocalPlayer do
    LocalPlayer = Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
end

-- Вспомогательные функции
local function createInstance(class, parent, props)
    local instance = Instance.new(class)
    if parent then
        instance.Parent = parent
    end
    for prop, value in pairs(props or {}) do
        instance[prop] = value
    end
    return instance
end

local function tween(instance, props, duration, easingStyle)
    local tweenInfo = TweenInfo.new(duration, easingStyle or Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(instance, tweenInfo, props)
    tween:Play()
    return tween
end

-- Основной объект SimpleGUI
function SimpleGUI.new(theme)
    local gui = { Windows = {} }
    local screenGui = createInstance("ScreenGui", nil, {
        Name = "SimpleGUI_" .. HttpService:GenerateGUID(false),
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 100
    })

    -- Защита GUI для эксплойтов
    local success, err = pcall(function()
        if syn and syn.protect_gui then
            syn.protect_gui(screenGui)
            screenGui.Parent = CoreGui
        elseif gethui then
            screenGui.Parent = gethui()
        else
            screenGui.Parent = CoreGui
        end
    end)
    if not success then
        screenGui.Parent = CoreGui
    end

    theme = theme or {
        PrimaryColor = Color3.fromRGB(30, 30, 30),
        SecondaryColor = Color3.fromRGB(50, 50, 50),
        TextColor = Color3.fromRGB(200, 200, 200),
        AccentColor = Color3.fromRGB(120, 120, 255),
        Font = Enum.Font.Gotham,
        TextSize = 16
    }

    -- Создание окна
    function gui:CreateWindow(config)
        local window = {}
        table.insert(gui.Windows, window)
        config = config or {}
        local draggable = config.Draggable ~= false
        local closable = config.Closable ~= false
        local visible = config.WindowVisible ~= false
        local width = config.Width or 600
        local height = config.Height or 400
        local showCleanupNotification = config.ShowCleanupNotification ~= false
        local configurationSaving = config.ConfigurationSaving or { Enabled = false, FolderName = "SimpleGUI", FileName = "Settings" }

        local windowFrame = createInstance("Frame", screenGui, {
            Name = config.Name or "Window",
            BackgroundColor3 = theme.PrimaryColor,
            Position = UDim2.new(0.5, -width / 2, 0.5, -height / 2),
            Size = UDim2.new(0, width, 0, height),
            BorderSizePixel = 0,
            Visible = visible
        })

        createInstance("UICorner", windowFrame, { CornerRadius = UDim.new(0, 8) })
        createInstance("UIGradient", windowFrame, {
            Color = ColorSequence.new(theme.PrimaryColor, theme.SecondaryColor)
        })

        -- Таблица для отслеживания эффектов
        local activeEffects = {
            connections = {},
            cleanups = {},
            values = {}
        }

        -- Таблица для настроек
        local settings = {}

        -- Функция очистки эффектов
        local function cleanupEffects()
            for key, connection in pairs(activeEffects.connections) do
                if connection then
                    connection:Disconnect()
                end
            end
            for key, cleanup in pairs(activeEffects.cleanups) do
                if cleanup then
                    cleanup()
                end
            end
            activeEffects.connections = {}
            activeEffects.cleanups = {}
            activeEffects.values = {}
            if showCleanupNotification then
                gui:Notify({
                    Title = "Очистка",
                    Content = "Все эффекты сброшены",
                    Type = "Info",
                    Duration = 3
                })
            end
        end

        -- Сохранение настроек
        function window:SaveConfiguration()
            if not configurationSaving.Enabled then return end
            local data = {}
            for key, value in pairs(activeEffects.values) do
                data[key] = value
            end
            local success, err
            if writefile and readfile then
                success, err = pcall(function()
                    local folder = configurationSaving.FolderName
                    local file = configurationSaving.FileName .. ".json"
                    if not isfolder(folder) then
                        makefolder(folder)
                    end
                    writefile(folder .. "/" .. file, HttpService:JSONEncode(data))
                end)
            else
                success, err = pcall(function()
                    local dataStore = DataStoreService:GetDataStore("SimpleGUI")
                    dataStore:SetAsync(configurationSaving.FileName, data)
                end)
            end
            if not success then
                gui:Notify({
                    Title = "Ошибка",
                    Content = "Не удалось сохранить настройки: " .. tostring(err),
                    Type = "Error",
                    Duration = 5
                })
            end
        end

        -- Загрузка настроек
        function window:LoadConfiguration()
            if not configurationSaving.Enabled then return end
            local success, data
            if isfile and readfile then
                success, data = pcall(function()
                    local folder = configurationSaving.FolderName
                    local file = configurationSaving.FileName .. ".json"
                    if isfile(folder .. "/" .. file) then
                        return HttpService:JSONDecode(readfile(folder .. "/" .. file))
                    end
                    return {}
                end)
            else
                success, data = pcall(function()
                    local dataStore = DataStoreService:GetDataStore("SimpleGUI")
                    return dataStore:GetAsync(configurationSaving.FileName) or {}
                end)
            end
            if success then
                settings = data
            else
                gui:Notify({
                    Title = "Ошибка",
                    Content = "Не удалось загрузить настройки",
                    Type = "Error",
                    Duration = 5
                })
            end
        end

        local topbar = createInstance("Frame", windowFrame, {
            Name = "Topbar",
            BackgroundColor3 = theme.SecondaryColor,
            Size = UDim2.new(1, 0, 0, 30),
            BorderSizePixel = 0
        })

        createInstance("UICorner", topbar, { CornerRadius = UDim.new(0, 6) })

        local title = createInstance("TextLabel", topbar, {
            BackgroundTransparency = 1,
            Position = UDim2.new(0.05, 0, 0, 0),
            Size = UDim2.new(0.8, 0, 1, 0),
            Font = theme.Font,
            Text = config.Name or "SimpleGUI",
            TextColor3 = theme.TextColor,
            TextSize = theme.TextSize,
            TextXAlignment = Enum.TextXAlignment.Left
        })

        -- Кнопка закрытия
        local closeButton
        if closable then
            closeButton = createInstance("TextButton", topbar, {
                Name = "CloseButton",
                BackgroundColor3 = theme.SecondaryColor,
                Position = UDim2.new(1, -25, 0, 5),
                Size = UDim2.new(0, 20, 0, 20),
                Font = theme.Font,
                Text = "X",
                TextColor3 = theme.TextColor,
                TextSize = theme.TextSize,
                ZIndex = 2
            })

            createInstance("UICorner", closeButton, { CornerRadius = UDim.new(0, 4) })

            closeButton.MouseEnter:Connect(function()
                tween(closeButton, {BackgroundColor3 = theme.AccentColor}, 0.2)
            end)
            closeButton.MouseLeave:Connect(function()
                tween(closeButton, {BackgroundColor3 = theme.SecondaryColor}, 0.2)
            end)

            closeButton.MouseButton1Click:Connect(function()
                window:HideWindow()
                tween(closeButton, {Size = UDim2.new(0, 18, 0, 18)}, 0.1).Completed:Connect(function()
                    tween(closeButton, {Size = UDim2.new(0, 20, 0, 20)}, 0.1)
                end)
            end)
        end

        -- Логика перемещения
        if draggable then
            local dragging = false
            local dragStart = nil
            local startPos = nil
            local dragConnection

            topbar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    dragStart = input.Position
                    startPos = windowFrame.Position
                    if dragConnection then
                        dragConnection:Disconnect()
                    end
                    dragConnection = UserInputService.InputChanged:Connect(function(input)
                        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                            local delta = input.Position - dragStart
                            local newPos = UDim2.new(
                                startPos.X.Scale,
                                startPos.X.Offset + delta.X,
                                startPos.Y.Scale,
                                startPos.Y.Offset + delta.Y
                            )
                            local screenSize = screenGui.AbsoluteSize
                            local frameSize = windowFrame.AbsoluteSize
                            newPos = UDim2.new(
                                0, math.clamp(newPos.X.Offset, 0, screenSize.X - frameSize.X),
                                0, math.clamp(newPos.Y.Offset, 0, screenSize.Y - frameSize.Y)
                            )
                            windowFrame.Position = newPos
                        end
                    end)
                end
            end)

            topbar.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                    if dragConnection then
                        dragConnection:Disconnect()
                        dragConnection = nil
                    end
                end
            end)
        end

        -- Боковая панель для вкладок
        local sidebar = createInstance("Frame", windowFrame, {
            Name = "Sidebar",
            BackgroundColor3 = theme.SecondaryColor,
            Position = UDim2.new(0, 0, 0, 30),
            Size = UDim2.new(0, 100, 1, -30),
            BorderSizePixel = 0
        })

        createInstance("UICorner", sidebar, { CornerRadius = UDim.new(0, 6) })

        local tabButtons = createInstance("Frame", sidebar, {
            Name = "TabButtons",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 5, 0, 5),
            Size = UDim2.new(1, -10, 1, -10)
        })

        local tabButtonLayout = createInstance("UIListLayout", tabButtons, {
            FillDirection = Enum.FillDirection.Vertical,
            HorizontalAlignment = Enum.HorizontalAlignment.Left,
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 5)
        })

        local tabContainer = createInstance("Frame", windowFrame, {
            Name = "TabContainer",
            BackgroundTransparency = 1,
            Position = UDim2.new(0, 100, 0, 30),
            Size = UDim2.new(1, -100, 1, -30)
        })

        local tabs = {}
        local activeTab = nil

        -- Создание вкладки
        function window:CreateTab(name, icon)
            local tab = {}
            local tabFrame = createInstance("Frame", tabContainer, {
                Name = name,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Visible = false
            })

            local tabButton = createInstance("TextButton", tabButtons, {
                Name = name .. "Button",
                BackgroundColor3 = theme.SecondaryColor,
                Size = UDim2.new(1, 0, 0, 30),
                Font = theme.Font,
                Text = (icon and icon .. " " or "") .. name,
                TextColor3 = theme.TextColor,
                TextSize = theme.TextSize,
                TextScaled = false
            })

            createInstance("UICorner", tabButton, { CornerRadius = UDim.new(0, 4) })

            tabButton.MouseEnter:Connect(function()
                if tabFrame ~= activeTab then
                    tween(tabButton, {BackgroundColor3 = theme.AccentColor:Lerp(theme.SecondaryColor, 0.7)}, 0.2)
                end
            end)
            tabButton.MouseLeave:Connect(function()
                if tabFrame ~= activeTab then
                    tween(tabButton, {BackgroundColor3 = theme.SecondaryColor}, 0.2)
                end
            end)

            local sections = {}

            local function activateTab()
                if activeTab then
                    activeTab.Visible = false
                end
                tabFrame.Visible = true
                activeTab = tabFrame
                for _, btn in pairs(tabButtons:GetChildren()) do
                    if btn:IsA("TextButton") then
                        btn.BackgroundColor3 = theme.SecondaryColor
                    end
                end
                tabButton.BackgroundColor3 = theme.AccentColor
            end

            tabButton.MouseButton1Click:Connect(activateTab)
            if not activeTab then
                activateTab()
            end

            -- Создание секции
            function tab:CreateSection(name)
                local section = {}
                local sectionFrame = createInstance("Frame", tabFrame, {
                    Name = name,
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, -10, 0, 100),
                    Position = UDim2.new(0, 5, 0, #sections * 110)
                })

                local sectionTitle = createInstance("TextLabel", sectionFrame, {
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 20),
                    Font = theme.Font,
                    Text = name,
                    TextColor3 = theme.TextColor,
                    TextSize = theme.TextSize,
                    TextXAlignment = Enum.TextXAlignment.Left
                })

                local elementContainer = createInstance("Frame", sectionFrame, {
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 0, 0, 25),
                    Size = UDim2.new(1, 0, 1, -25)
                })

                local elementLayout = createInstance("UIListLayout", elementContainer, {
                    SortOrder = Enum.SortOrder.LayoutOrder,
                    Padding = UDim.new(0, 5)
                })

                -- Создание кнопки
                function section:CreateButton(config)
                    local button = createInstance("TextButton", elementContainer, {
                        Name = config.Name,
                        BackgroundColor3 = theme.SecondaryColor,
                        Size = UDim2.new(1, -10, 0, 30),
                        Position = UDim2.new(0, 5, 0, 0),
                        Font = theme.Font,
                        Text = config.Name,
                        TextColor3 = theme.TextColor,
                        TextSize = theme

.TextSize
                    })

                    createInstance("UICorner", button, { CornerRadius = UDim.new(0, 4) })

                    button.MouseButton1Click:Connect(function()
                        if config.Callback then
                            local connection, cleanup = config.Callback()
                            if connection then
                                activeEffects.connections[config.Name .. "_Button"] = connection
                            end
                            if config.Cleanup then
                                activeEffects.cleanups[config.Name .. "_Button"] = config.Cleanup
                            end
                        end
                    end)

                    button.MouseEnter:Connect(function()
                        tween(button, {BackgroundColor3 = theme.AccentColor}, 0.2)
                    end)
                    button.MouseLeave:Connect(function()
                        tween(button, {BackgroundColor3 = theme.SecondaryColor}, 0.2)
                    end)
                end

                -- Создание переключателя
                function section:CreateToggle(config)
                    local state = settings[config.Name] or config.Default or false
                    local toggleFrame = createInstance("Frame", elementContainer, {
                        Name = config.Name,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, -10, 0, 30)
                    })

                    local label = createInstance("TextLabel", toggleFrame, {
                        BackgroundTransparency = 1,
                        Size = UDim2.new(0.8, 0, 1, 0),
                        Font = theme.Font,
                        Text = config.Name .. ": " .. (state and "Вкл" or "Выкл"),
                        TextColor3 = theme.TextColor,
                        TextSize = theme.TextSize,
                        TextXAlignment = Enum.TextXAlignment.Left
                    })

                    local toggle = createInstance("Frame", toggleFrame, {
                        BackgroundColor3 = state and theme.AccentColor or theme.SecondaryColor,
                        Size = UDim2.new(0, 40, 0, 20),
                        Position = UDim2.new(1, -40, 0.5, -10)
                    })

                    createInstance("UICorner", toggle, { CornerRadius = UDim.new(0, 10) })

                    local circle = createInstance("Frame", toggle, {
                        BackgroundColor3 = theme.TextColor,
                        Size = UDim2.new(0, 16, 0, 16),
                        Position = state and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
                    })

                    createInstance("UICorner", circle, { CornerRadius = UDim.new(0, 8) })

                    toggleFrame.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            state = not state
                            tween(circle, {Position = state and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)}, 0.2)
                            tween(toggle, {BackgroundColor3 = state and theme.AccentColor or theme.SecondaryColor}, 0.2)
                            label.Text = config.Name .. ": " .. (state and "Вкл" or "Выкл")
                            activeEffects.values[config.Name] = state
                            window:SaveConfiguration()
                            if config.Callback then
                                local connection, cleanup = config.Callback(state)
                                if connection then
                                    activeEffects.connections[config.Name .. "_Toggle"] = connection
                                end
                                if config.Cleanup then
                                    activeEffects.cleanups[config.Name .. "_Toggle"] = config.Cleanup
                                end
                            end
                        end
                    end)
                end

                -- Создание слайдера
                function section:CreateSlider(config)
                    local value = settings[config.Name] or config.Default or config.Min
                    local sliderFrame = createInstance("Frame", elementContainer, {
                        Name = config.Name,
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, -10, 0, 50)
                    })

                    local label = createInstance("TextLabel", sliderFrame, {
                        BackgroundTransparency = 1,
                        Size = UDim2.new(1, 0, 0, 20),
                        Font = theme.Font,
                        Text = config.Name .. ": " .. value,
                        TextColor3 = theme.TextColor,
                        TextSize = theme.TextSize
                    })

                    local sliderBar = createInstance("Frame", sliderFrame, {
                        BackgroundColor3 = theme.SecondaryColor,
                        Size = UDim2.new(1, 0, 0, 10),
                        Position = UDim2.new(0, 0, 0, 25)
                    })

                    createInstance("UICorner", sliderBar, { CornerRadius = UDim.new(0, 5) })

                    local fill = createInstance("Frame", sliderBar, {
                        BackgroundColor3 = theme.AccentColor,
                        Size = UDim2.new((value - config.Min) / (config.Max - config.Min), 0, 1, 0)
                    })

                    createInstance("UICorner", fill, { CornerRadius = UDim.new(0, 5) })

                    local dragging = false
                    sliderBar.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging = true
                        end
                    end)

--嫌いなものがある場合は、それを教えてください。
